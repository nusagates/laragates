import{a as X,c as I,r as b,b as y,d as i,o as r,e as n,u as L,g as Y,w as v,i as t,Q as M,j as x,h,f as ee,C as T,E as te,t as g,F as A,k as z,G as ae,l as O}from"./app-z_qK7d6H.js";import{A as le}from"./AdminLayout-DDNgbf8P.js";import{_ as se}from"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css                                                                    */const ne={class:"d-flex justify-space-between align-center mb-4 px-4"},oe={class:"pa-4"},re={class:"d-flex"},ie={style:{flex:"2","margin-right":"20px"}},de={key:0,class:"mt-3 mb-4"},ue={class:"d-flex align-center",style:{"flex-direction":"column",gap:"12px"}},pe={key:0,class:"text-caption mt-1"},ve={key:0,class:"mt-3"},me={class:"text-caption"},ce={key:0,class:"mt-2",style:{background:"#fafafa",border:"1px solid #eee",padding:"8px","border-radius":"8px"}},fe={key:1,class:"mt-2 red--text text-caption"},ge={class:"d-flex justify-end mt-6",style:{gap:"10px"}},_e={key:2,class:"mt-4"},be={style:{height:"8px",background:"#eee","border-radius":"6px",overflow:"hidden"}},ye={class:"text-caption mt-2"},xe={style:{flex:"1"}},he={key:0},ke=["innerHTML"],Ce={key:1,class:"text-body-2 text-grey-darken-1"},we={key:0},Ve={__name:"Index",setup(Se){const P=X(),R=I(()=>P.props.templates||[]),j=I(()=>P.props.history||[]),a=b({name:"",template_id:null,audience_type:"csv",schedule_type:"now",send_at:null,csv_file:null}),B=b(!1),w=b({}),$=b(""),V=b(!1),m=b({count:null,sample:[],errors:[]}),S=b(0),F=b(!1),H=b(null),U=I(()=>R.value.find(l=>l.id===a.value.template_id)||null);function N(l){var e;return((e=w.value[l])==null?void 0:e[0])||""}function J(l){var o;const e=((o=l.target.files)==null?void 0:o[0])??null;e&&E(e)}function G(l){var o;V.value=!1;const e=((o=l.dataTransfer.files)==null?void 0:o[0])??null;e&&E(e)}function Q(){V.value=!0}function W(){V.value=!1}function E(l){if(m.value={count:null,sample:[],errors:[]},a.value.csv_file=l,$.value=l.name,!l.name.toLowerCase().endsWith(".csv")){m.value.errors.push("File harus berekstensi .csv");return}const e=new FileReader;e.onload=o=>{const u=String(o.target.result||"").split(/\r\n|\n/).map(p=>p.trim()).filter(p=>p);let d=0;u.length&&/[a-zA-Z]/.test(u[0])&&(d=1);const k=[],C=[];for(let p=d;p<Math.min(u.length,2e3);p++){const _=u[p].split(",").map(f=>f.trim());if(_.length===1){const f=_[0].replace(/\s+/g,"");/^\d{6,15}$/.test(f)?k.push({phone:f}):C.push(`Baris ${p+1}: nomor tidak valid (${_[0]})`)}else{const f={name:_[0],phone:_[1].replace(/\s+/g,"")};if(_[2])try{f.variables=JSON.parse(_[2])}catch{f.variables=[],C.push(`Baris ${p+1}: kolom variables bukan JSON valid`)}/^\d{6,15}$/.test(f.phone)?k.push(f):C.push(`Baris ${p+1}: nomor tidak valid (${_[1]})`)}}m.value.count=Math.max(0,u.length-d),m.value.sample=k.slice(0,6),m.value.errors=C},e.onerror=()=>{m.value.errors.push("Tidak bisa membaca file CSV")},e.readAsText(l)}function q(l){return l?l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\{\{(\d+)\}\}/g,(o,c)=>`<span style="padding:2px 6px;background:#FFF7C6;color:#8A6D00;border-radius:6px;margin-right:4px">var${c}</span>`).replace(/\n/g,"<br/>"):""}async function Z(){var l;B.value=!0,w.value={};try{const e=new FormData;e.append("name",a.value.name),e.append("template_id",a.value.template_id||""),e.append("audience_type",a.value.audience_type),e.append("schedule_type",a.value.schedule_type),a.value.schedule_type==="later"&&a.value.send_at&&e.append("send_at",a.value.send_at);const o=await O.post(route("broadcast.store"),e),c=o.data.campaign??o.data,u=c.id??c;H.value=u,a.value.audience_type==="csv"&&a.value.csv_file&&await K(u,a.value.csv_file),await O.post(route("broadcast.request-approval",{campaign:u}),{notes:"Submitted from UI"}).catch(()=>{}),M.visit(route("broadcast"),{preserveScroll:!0})}catch(e){((l=e.response)==null?void 0:l.status)===422?w.value=e.response.data.errors:alert("Gagal membuat broadcast.")}finally{B.value=!1}}async function K(l,e){var c,u;F.value=!0,S.value=0;const o=new FormData;o.append("file",e);try{await O.post(`/broadcast/campaigns/${l}/upload-targets`,o,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress(d){d.lengthComputable&&(S.value=Math.round(d.loaded*100/d.total))}})}catch(d){throw w.value.csv_file=[((u=(c=d.response)==null?void 0:c.data)==null?void 0:u.message)??"Upload targets gagal"],d}finally{F.value=!1}}return(l,e)=>{const o=y("v-btn"),c=y("v-text-field"),u=y("v-select"),d=y("v-radio"),k=y("v-radio-group"),C=y("v-icon"),p=y("v-card"),_=y("v-sheet"),f=y("v-table");return r(),i(A,null,[n(L(Y),{title:"Broadcast"}),n(le,null,{title:v(()=>e[9]||(e[9]=[x("Broadcast")])),default:v(()=>[t("div",ne,[e[11]||(e[11]=t("h2",{class:"text-h5 font-weight-bold"},"Create Broadcast Campaign",-1)),n(o,{color:"indigo-darken-3",variant:"tonal","prepend-icon":"mdi-chart-box-outline",onClick:e[0]||(e[0]=s=>L(M).visit(l.route("broadcast.report")))},{default:v(()=>e[10]||(e[10]=[x(" View Report ")])),_:1,__:[10]})]),t("div",oe,[t("div",re,[t("div",ie,[n(p,{elevation:"2",class:"pa-4",style:{"border-radius":"12px"}},{default:v(()=>[n(c,{modelValue:a.value.name,"onUpdate:modelValue":e[1]||(e[1]=s=>a.value.name=s),label:"Campaign Name",dense:"","error-messages":N("name"),class:"mb-4"},null,8,["modelValue","error-messages"]),n(u,{modelValue:a.value.template_id,"onUpdate:modelValue":e[2]||(e[2]=s=>a.value.template_id=s),items:R.value,"item-title":"name","item-value":"id",label:"Template Message",dense:"","error-messages":N("template_id"),class:"mb-4"},null,8,["modelValue","items","error-messages"]),e[20]||(e[20]=t("h4",{class:"text-subtitle-2 mb-2"},"Audience",-1)),n(k,{modelValue:a.value.audience_type,"onUpdate:modelValue":e[3]||(e[3]=s=>a.value.audience_type=s),inline:""},{default:v(()=>[n(d,{label:"All Customers (TODO)",value:"all"}),n(d,{label:"Upload CSV",value:"csv"})]),_:1},8,["modelValue"]),a.value.audience_type==="csv"?(r(),i("div",de,[e[17]||(e[17]=t("p",{class:"text-body-2 mb-1"},[x(" Upload file CSV berisi nomor WhatsApp. Contoh: "),t("code",null,"6281234567890")],-1)),t("div",{class:te(["dropzone-box",{active:V.value}]),onDragenter:T(Q,["prevent"]),onDragleave:T(W,["prevent"]),onDragover:e[5]||(e[5]=T(()=>{},["prevent"])),onDrop:T(G,["prevent"])},[t("div",ue,[n(C,{size:"36"},{default:v(()=>e[12]||(e[12]=[x("mdi-upload")])),_:1,__:[12]}),e[15]||(e[15]=t("div",{class:"text-body-2"},"Drag & drop CSV atau klik tombol",-1)),n(o,{small:"",variant:"tonal",onClick:e[4]||(e[4]=s=>l.$refs.csvInput.click())},{default:v(()=>e[13]||(e[13]=[x("Choose File")])),_:1,__:[13]}),t("input",{ref:"csvInput",type:"file",class:"d-none",accept:".csv",onChange:J},null,544),$.value?(r(),i("div",pe,[e[14]||(e[14]=t("strong",null,"Selected:",-1)),x(" "+g($.value),1)])):h("",!0)])],34),m.value.count!==null?(r(),i("div",ve,[t("div",me,[e[16]||(e[16]=x("Rows parsed: ")),t("strong",null,g(m.value.count),1)]),m.value.sample.length?(r(),i("div",ce,[(r(!0),i(A,null,z(m.value.sample,(s,D)=>(r(),i("div",{key:D,style:{"font-size":"13px"}},g(D+1)+". "+g(JSON.stringify(s)),1))),128))])):h("",!0),m.value.errors.length?(r(),i("div",fe,[(r(!0),i(A,null,z(m.value.errors,(s,D)=>(r(),i("div",{key:D},g(s),1))),128))])):h("",!0)])):h("",!0)])):h("",!0),e[21]||(e[21]=t("h4",{class:"text-subtitle-2 mt-3 mb-2"},"Schedule",-1)),n(k,{modelValue:a.value.schedule_type,"onUpdate:modelValue":e[6]||(e[6]=s=>a.value.schedule_type=s),inline:""},{default:v(()=>[n(d,{label:"Send Now",value:"now"}),n(d,{label:"Schedule Later",value:"later"})]),_:1},8,["modelValue"]),a.value.schedule_type==="later"?(r(),ee(c,{key:1,modelValue:a.value.send_at,"onUpdate:modelValue":e[7]||(e[7]=s=>a.value.send_at=s),type:"datetime-local",label:"Send At",dense:"",class:"mt-2","error-messages":N("send_at")},null,8,["modelValue","error-messages"])):h("",!0),t("div",ge,[n(o,{variant:"text",onClick:e[8]||(e[8]=s=>L(M).visit(l.route("broadcast")))},{default:v(()=>e[18]||(e[18]=[x("Cancel")])),_:1,__:[18]}),n(o,{color:"primary",loading:B.value,onClick:Z},{default:v(()=>e[19]||(e[19]=[x("START BROADCAST")])),_:1,__:[19]},8,["loading"])]),F.value?(r(),i("div",_e,[t("div",be,[t("div",{style:ae({width:S.value+"%",background:"#4caf50",height:"8px"})},null,4)]),t("div",ye,"Uploading "+g(S.value)+"%",1)])):h("",!0)]),_:1,__:[20,21]})]),t("div",xe,[n(p,{elevation:"2",class:"pa-4 mb-4",style:{"border-radius":"12px"}},{default:v(()=>[e[22]||(e[22]=t("h4",{class:"text-subtitle-1 font-weight-bold mb-2"},"Selected Template Preview",-1)),n(_,{class:"pa-3 mt-2",color:"grey-lighten-4",style:{"border-radius":"12px"}},{default:v(()=>[U.value?(r(),i("div",he,[t("strong",null,g(U.value.name),1),t("div",{class:"text-body-2 mt-2",innerHTML:q(U.value.body)},null,8,ke)])):(r(),i("div",Ce," Pilih template untuk melihat preview. "))]),_:1})]),_:1,__:[22]}),n(p,{elevation:"2",class:"pa-4",style:{"border-radius":"12px"}},{default:v(()=>[e[25]||(e[25]=t("h4",{class:"text-subtitle-1 font-weight-bold mb-2"},"History",-1)),n(f,{density:"compact"},{default:v(()=>[e[24]||(e[24]=t("thead",null,[t("tr",null,[t("th",null,"Campaign"),t("th",null,"Sent"),t("th",null,"Date")])],-1)),t("tbody",null,[j.value.length?h("",!0):(r(),i("tr",we,e[23]||(e[23]=[t("td",{colspan:"3",class:"text-center"},"Belum ada riwayat broadcast.",-1)]))),(r(!0),i(A,null,z(j.value,s=>(r(),i("tr",{key:s.id},[t("td",null,[t("strong",null,g(s.name),1)]),t("td",null,g(s.sent)+" / "+g(s.failed)+" failed",1),t("td",null,g(s.date),1)]))),128))])]),_:1,__:[24]})]),_:1,__:[25]})])])])]),_:1})],64)}}},$e=se(Ve,[["__scopeId","data-v-526288ca"]]);export{$e as default};
