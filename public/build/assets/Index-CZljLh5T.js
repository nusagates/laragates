import{A as te}from"./AdminLayout-O7Oxasoz.js";import{I as ae,r as m,m as le,c as oe,b as s,d as S,o as v,e as t,u as se,g as ne,w as l,i as u,j as d,f as w,h as V,F as W,k as ie,E as ue,t as N,l as T}from"./app-BqckiNoC.js";import re from"./Room-CZm0K1uD.js";import{_ as de}from"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css                                                                    */const ce={class:"chat-flex"},me={class:"chat-sidebar"},ve={class:"d-flex align-center mb-3"},_e={class:"white--text"},pe={class:"text-grey"},fe={class:"chat-room"},ge={class:"chat-body"},he={class:"px-4 py-2 d-flex justify-end"},ye={class:"chat-input"},ke={class:"d-flex justify-end gap-2"},we={__name:"Index",setup(xe){const M=ae(),p=m([]),f=m(""),r=m(null),g=m(""),h=m(null),x=m(null),y=m(!1),L=m(!1),n=m({name:"",phone:"",message:"",create_ticket:!1});async function b(){var a,e;try{const i=await T.get("/chat/sessions");p.value=i.data,!r.value&&((a=p.value)!=null&&a.length)&&(r.value=(e=p.value[0])==null?void 0:e.session_id)}catch(i){console.error(i)}}le(()=>{var e,i,_;b();const a=((i=(e=window==null?void 0:window.Laravel)==null?void 0:e.user)==null?void 0:i.id)??((_=document.querySelector('meta[name="user-id"]'))==null?void 0:_.content)??null;a&&window.Echo.private(`agent.${a}`).listen(".session.assigned",c=>{var k,C;b(),M.success(`New chat from ${((k=c.session.customer)==null?void 0:k.name)??((C=c.session.customer)==null?void 0:C.phone)}`,{timeout:3200,icon:"ðŸ’¬"})})});const $=oe(()=>f.value?p.value.filter(a=>{const e=(a.customer_name??"").toLowerCase(),i=(a.phone??"").toLowerCase();return e.includes(f.value.toLowerCase())||i.includes(f.value.toLowerCase())}):p.value);function P(a){r.value=a}function R(a){h.value=a.target.files[0]||null}async function G(){var e;if(!r.value||!g.value.trim()&&!h.value)return;let a=new FormData;a.append("message",g.value||""),h.value&&a.append("media",h.value),g.value="",h.value=null,x.value&&(x.value.value="");try{const i=await T.post(`/chat/sessions/${r.value}/messages`,a,{headers:{"Content-Type":"multipart/form-data"}});window.dispatchEvent(new CustomEvent("agent-message-sent",{detail:(e=i.data)==null?void 0:e.data}))}catch(i){console.error(i),alert("Gagal mengirim pesan!")}}function E(){let a=n.value.phone||"";if(a=a.trim().replace(/[^0-9+]/g,""),!a)return n.value.phone="";if(a.startsWith("+"))return n.value.phone=a;if(a.startsWith("0"))return n.value.phone="+62"+a.slice(1);if(a.startsWith("62"))return n.value.phone="+"+a;n.value.phone="+"+a}function q(){n.value={name:"",phone:"",message:"",create_ticket:!1},y.value=!0}async function z(){var a;if(!n.value.phone||!n.value.message)return alert("Phone dan message wajib diisi.");L.value=!0,E();try{const e=await T.post("/chat/sessions/outbound",n.value);y.value=!1,await b(),(a=e.data)!=null&&a.session_id&&(r.value=e.data.session_id)}catch(e){console.error(e),alert("Gagal membuat chat baru.")}finally{L.value=!1}}async function K(){var a;if(r.value)try{const e=await T.post(`/chat/sessions/${r.value}/convert-ticket`);alert("Ticket berhasil dibuat. ID: "+((a=e.data)==null?void 0:a.ticket_id)),b()}catch(e){console.error(e),alert("Gagal membuat ticket.")}}return(a,e)=>{const i=s("v-text-field"),_=s("v-icon"),c=s("v-btn"),k=s("v-divider"),C=s("v-avatar"),H=s("v-list-item-avatar"),j=s("v-list-item-title"),J=s("v-list-item-subtitle"),O=s("v-list-item-content"),A=s("v-badge"),Q=s("v-list-item-action"),B=s("v-list-item"),X=s("v-list"),U=s("v-card"),F=s("v-col"),D=s("v-textarea"),Y=s("v-row"),Z=s("v-checkbox"),ee=s("v-dialog");return v(),S(W,null,[t(se(ne),{title:"Chat"}),t(te,null,{title:l(()=>e[9]||(e[9]=[d("Chat")])),default:l(()=>[u("div",ce,[u("div",me,[t(U,{class:"pa-4 chat-list",elevation:"2"},{default:l(()=>[u("div",ve,[t(i,{modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=o=>f.value=o),placeholder:"Search customer or phone...",density:"comfortable",rounded:"","hide-details":"","prepend-inner-icon":"mdi-magnify",class:"flex-grow-1 mr-2"},null,8,["modelValue"]),t(c,{color:"primary",icon:"",onClick:q},{default:l(()=>[t(_,null,{default:l(()=>e[10]||(e[10]=[d("mdi-message-plus")])),_:1,__:[10]})]),_:1})]),t(k),t(X,{"two-line":"",density:"comfortable"},{default:l(()=>[(v(!0),S(W,null,ie($.value,o=>(v(),w(B,{key:o.session_id,onClick:I=>P(o.session_id),class:ue({"bg-highlight":o.session_id===r.value}),style:{cursor:"pointer"}},{default:l(()=>[t(H,null,{default:l(()=>[t(C,{color:"blue"},{default:l(()=>[u("span",_e,N((o.customer_name??"U").charAt(0)),1)]),_:2},1024)]),_:2},1024),t(O,null,{default:l(()=>[t(j,{class:"d-flex justify-space-between"},{default:l(()=>[u("span",null,N(o.customer_name??o.phone),1),u("small",pe,N(o.time),1)]),_:2},1024),t(J,{class:"text-truncate"},{default:l(()=>[d(N(o.last_message||"..."),1)]),_:2},1024)]),_:2},1024),t(Q,null,{default:l(()=>[o.has_ticket?(v(),w(A,{key:0,color:"green",icon:"mdi-ticket-confirmation"})):V("",!0),o.unread_count?(v(),w(A,{key:1,content:o.unread_count,color:"red"},null,8,["content"])):V("",!0)]),_:2},1024)]),_:2},1032,["onClick","class"]))),128)),$.value.length?V("",!0):(v(),w(B,{key:0},{default:l(()=>[t(j,{class:"text-center text-grey"},{default:l(()=>e[11]||(e[11]=[d("No chats")])),_:1,__:[11]})]),_:1}))]),_:1})]),_:1})]),u("div",fe,[t(U,{class:"chat-window",elevation:"2"},{default:l(()=>[u("div",ge,[t(re,{"room-id":r.value},null,8,["room-id"])]),u("div",he,[r.value?(v(),w(c,{key:0,color:"green",variant:"outlined",onClick:K},{default:l(()=>[t(_,{start:""},{default:l(()=>e[12]||(e[12]=[d("mdi-ticket-confirmation-outline")])),_:1,__:[12]}),e[13]||(e[13]=d(" Convert to Ticket "))]),_:1,__:[13]})):V("",!0)]),u("div",ye,[t(Y,{align:"center",class:"no-gutters"},{default:l(()=>[t(F,{cols:"auto"},{default:l(()=>[u("input",{type:"file",ref_key:"filePicker",ref:x,style:{display:"none"},onChange:R,accept:"image/*,.pdf,.doc,.docx"},null,544),t(c,{icon:"",onClick:e[1]||(e[1]=o=>{var I;return(I=x.value)==null?void 0:I.click()})},{default:l(()=>[t(_,null,{default:l(()=>e[14]||(e[14]=[d("mdi-paperclip")])),_:1,__:[14]})]),_:1})]),_:1}),t(F,null,{default:l(()=>[t(D,{modelValue:g.value,"onUpdate:modelValue":e[2]||(e[2]=o=>g.value=o),placeholder:"Type a message",rows:"1","auto-grow":"",variant:"outlined",class:"me-2"},null,8,["modelValue"])]),_:1}),t(F,{cols:"auto"},{default:l(()=>[t(c,{color:"primary",onClick:G},{default:l(()=>e[15]||(e[15]=[d("SEND")])),_:1,__:[15]})]),_:1})]),_:1})])]),_:1})])]),t(ee,{modelValue:y.value,"onUpdate:modelValue":e[8]||(e[8]=o=>y.value=o),"max-width":"480"},{default:l(()=>[t(U,{class:"pa-4"},{default:l(()=>[e[18]||(e[18]=u("h3",{class:"text-h6 mb-3"},"New Chat",-1)),e[19]||(e[19]=u("p",{class:"text-body-2 text-grey-darken-1 mb-4"},"Kirim pesan WhatsApp pertama ke customer.",-1)),t(i,{modelValue:n.value.name,"onUpdate:modelValue":e[3]||(e[3]=o=>n.value.name=o),label:"Customer Name (optional)",class:"mb-3"},null,8,["modelValue"]),t(i,{modelValue:n.value.phone,"onUpdate:modelValue":e[4]||(e[4]=o=>n.value.phone=o),label:"WhatsApp Number",placeholder:"0812xxxx / +62812xxxx",class:"mb-3",onBlur:E},null,8,["modelValue"]),t(D,{modelValue:n.value.message,"onUpdate:modelValue":e[5]||(e[5]=o=>n.value.message=o),label:"First Message",rows:"2","auto-grow":"",class:"mb-3"},null,8,["modelValue"]),t(Z,{modelValue:n.value.create_ticket,"onUpdate:modelValue":e[6]||(e[6]=o=>n.value.create_ticket=o),label:"Create Ticket from this chat",class:"mb-2"},null,8,["modelValue"]),t(k,{class:"my-3"}),u("div",ke,[t(c,{variant:"text",onClick:e[7]||(e[7]=o=>y.value=!1)},{default:l(()=>e[16]||(e[16]=[d("Cancel")])),_:1,__:[16]}),t(c,{color:"primary",loading:L.value,onClick:z},{default:l(()=>e[17]||(e[17]=[d("Start Chat")])),_:1,__:[17]},8,["loading"])])]),_:1,__:[18,19]})]),_:1},8,["modelValue"])]),_:1})],64)}}},Le=de(we,[["__scopeId","data-v-18076ba1"]]);export{Le as default};
