import{a as h,G as j,c as D,r as v,b as i,d as m,o as u,e as t,u as x,g as K,w as r,h as s,Q as A,i as c,k as O,f as S,C as F,D as W,t as g,F as L,j as q,l as J}from"./app-CsZa9FYx.js";import{A as X}from"./AdminLayout-B9id1OaC.js";import{_ as Y}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Z={class:"broadcast-dark"},ee={class:"header-card"},ae={class:"grid"},le={class:"dropzone-actions"},te={key:0,class:"filename-display"},se={class:"actions"},oe={key:1,class:"mt-3"},ne=["innerHTML"],de={key:1,class:"muted"},re={__name:"Index",setup(ie){const U=h(),b=j(),$=D(()=>U.props.templates||[]),P=D(()=>U.props.history||[]),a=v({name:"",template_id:null,audience_type:"upload",schedule_type:"now",send_at:null,csv_file:null}),V=v(!1),k=v({}),C=v(""),M=v(!1),w=v(0),T=v(!1),N=D(()=>$.value.find(l=>l.id===a.value.template_id)||null);function H(l){var e;return((e=k.value[l])==null?void 0:e[0])||""}function I(l){var d;const e=(d=l.target.files)==null?void 0:d[0];e&&z(e)}function R(l){var d;M.value=!1;const e=(d=l.dataTransfer.files)==null?void 0:d[0];e&&z(e)}function z(l){a.value.csv_file=l,C.value=l.name}function E(l){return l?l.replace(/\{\{(\d+)\}\}/g,'<span class="var-chip">var$1</span>').replace(/\n/g,"<br/>"):""}async function G(){var l,e,d;V.value=!0,k.value={},T.value=!0;try{const n=new FormData;n.append("name",a.value.name),n.append("template_id",a.value.template_id),n.append("audience_type",a.value.audience_type),n.append("schedule_type",a.value.schedule_type),a.value.send_at&&n.append("send_at",a.value.send_at),a.value.csv_file&&n.append("csv_file",a.value.csv_file);const p=(await J.post(route("broadcast.store"),n,{onUploadProgress(f){f.lengthComputable&&(w.value=Math.round(f.loaded*100/f.total))}})).data.campaign,_=(p==null?void 0:p.total_targets)||0;b.success(`Broadcast campaign "${a.value.name}" berhasil dibuat!${_>0?` (${_} targets)`:""}`),A.visit(route("broadcast"))}catch(n){if(console.error(n),((l=n.response)==null?void 0:l.status)===422)k.value=n.response.data.errors,b.error("Terdapat kesalahan pada form. Mohon periksa kembali.");else{const y=((d=(e=n.response)==null?void 0:e.data)==null?void 0:d.message)||"Gagal membuat broadcast campaign";b.error(y)}}finally{V.value=!1,T.value=!1,w.value=0}}return(l,e)=>{const d=i("v-btn"),n=i("v-text-field"),y=i("v-select"),p=i("v-radio"),_=i("v-radio-group"),f=i("v-icon"),B=i("v-card"),Q=i("v-table");return u(),m(L,null,[t(x(K),{title:"Broadcast"}),t(X,null,{title:r(()=>e[9]||(e[9]=[c("Broadcast")])),default:r(()=>[s("div",Z,[s("div",ee,[e[11]||(e[11]=s("div",null,[s("h3",null,"Create Broadcast Campaign"),s("p",null,"Kirim pesan massal menggunakan template WhatsApp")],-1)),t(d,{color:"primary","prepend-icon":"mdi-chart-box",onClick:e[0]||(e[0]=o=>x(A).visit(l.route("broadcast.reports")))},{default:r(()=>e[10]||(e[10]=[c(" View Report ")])),_:1,__:[10]})]),s("div",ae,[t(B,{class:"card pa-4"},{default:r(()=>[t(n,{modelValue:a.value.name,"onUpdate:modelValue":e[1]||(e[1]=o=>a.value.name=o),label:"Campaign Name","error-messages":H("name")},null,8,["modelValue","error-messages"]),t(y,{modelValue:a.value.template_id,"onUpdate:modelValue":e[2]||(e[2]=o=>a.value.template_id=o),items:$.value,"item-title":"name","item-value":"id",label:"Template Message",class:"mt-3"},null,8,["modelValue","items"]),e[18]||(e[18]=s("h4",{class:"section"},"Audience",-1)),t(_,{modelValue:a.value.audience_type,"onUpdate:modelValue":e[3]||(e[3]=o=>a.value.audience_type=o),inline:""},{default:r(()=>[t(p,{label:"Upload CSV",value:"upload"})]),_:1},8,["modelValue"]),s("div",{class:W(["dropzone",{active:M.value}]),onDragover:e[5]||(e[5]=F(()=>{},["prevent"])),onDrop:F(R,["prevent"])},[t(f,{size:"32"},{default:r(()=>e[12]||(e[12]=[c("mdi-upload")])),_:1,__:[12]}),e[15]||(e[15]=s("p",null,"Drag CSV atau klik",-1)),s("div",le,[t(d,{size:"small",variant:"tonal",onClick:e[4]||(e[4]=o=>l.$refs.csv.click())},{default:r(()=>e[13]||(e[13]=[c(" Choose File ")])),_:1,__:[13]}),t(d,{size:"small",variant:"text",color:"primary","prepend-icon":"mdi-download",href:l.route("broadcast.download-sample-csv"),download:""},{default:r(()=>e[14]||(e[14]=[c(" Download Sample ")])),_:1,__:[14]},8,["href"])]),s("input",{ref:"csv",type:"file",hidden:"",accept:".csv",onChange:I},null,544),C.value?(u(),m("small",te,g(C.value),1)):S("",!0)],34),e[19]||(e[19]=s("h4",{class:"section"},"Schedule",-1)),t(_,{modelValue:a.value.schedule_type,"onUpdate:modelValue":e[6]||(e[6]=o=>a.value.schedule_type=o),inline:""},{default:r(()=>[t(p,{label:"Send Now",value:"now"}),t(p,{label:"Later",value:"later"})]),_:1},8,["modelValue"]),a.value.schedule_type==="later"?(u(),O(n,{key:0,modelValue:a.value.send_at,"onUpdate:modelValue":e[7]||(e[7]=o=>a.value.send_at=o),type:"datetime-local"},null,8,["modelValue"])):S("",!0),s("div",se,[t(d,{variant:"text",onClick:e[8]||(e[8]=o=>x(A).visit(l.route("broadcast")))},{default:r(()=>e[16]||(e[16]=[c(" Cancel ")])),_:1,__:[16]}),t(d,{color:"primary",loading:V.value,onClick:G},{default:r(()=>e[17]||(e[17]=[c(" START BROADCAST ")])),_:1,__:[17]},8,["loading"])]),T.value?(u(),m("div",oe," Uploading "+g(w.value)+"% ",1)):S("",!0)]),_:1,__:[18,19]}),s("div",null,[t(B,{class:"card pa-4 mb-4"},{default:r(()=>[e[20]||(e[20]=s("h4",null,"Template Preview",-1)),N.value?(u(),m("div",{key:0,class:"preview",innerHTML:E(N.value.body)},null,8,ne)):(u(),m("p",de,"Pilih template"))]),_:1,__:[20]}),t(B,{class:"card pa-4"},{default:r(()=>[e[21]||(e[21]=s("h4",null,"History",-1)),t(Q,{density:"compact"},{default:r(()=>[s("tbody",null,[(u(!0),m(L,null,q(P.value,o=>(u(),m("tr",{key:o.id},[s("td",null,g(o.name),1),s("td",null,g(o.sent)+"/"+g(o.failed),1)]))),128))])]),_:1})]),_:1,__:[21]})])])])]),_:1})],64)}}},me=Y(re,[["__scopeId","data-v-ad09475f"]]);export{me as default};
